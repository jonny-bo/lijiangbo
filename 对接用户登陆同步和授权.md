# 对接用户登陆同步和授权

## 项目描述
- 项目名称：百迈克定制
- 启动时间：2017.7.24
- ES 版本：x8 <code>8.0.17</code>
- 流程图：
![百迈客定制项目流程图](./data/百迈客定制项目流程图.png) 
1. 用户在未登录百迈克并在es中访问登陆的时候，会跳转到百迈克的登陆站去请求登陆，并且附带callback回调授权路径，百迈克那边登陆完成时候判断有无callback路径，有的话说明需要登陆es，则请求es的access_token接口，传递用户信息．获取access_token成功后会把access_token加到callbake的参数里，并且访问完成登陆．
2. 用户在登录百迈克的状态下访问es入口，则需要请求获取access_token，然后访问http://domain/auth?access_token=xxxx进行认证授权同步登录到es系统
3. 用户信息同步，在百迈克用户信息修改的时候需要同步用户信息到es系统去，通过访问用户信息同步接口同步信息

## 开发前准备
1. [新的apibundle接口开发方式学习](./x8-apibundle接口开发.md)
2. 签名认证的实现方式
3. 用户绑定模式和token生成
4. 用户认证和授权机制

## MD5参数签名的方式：
网上资料介绍：[API接口签名验证](http://www.jianshu.com/p/d47da77b6419)
1. 约定好secret值
2. 客户端将secret+time时间戳+key按照一定规则拼接并md5加密成签名sign
3. 客户端在访问服务端接口时传递time时间戳，key值和生成的签名sign
4. 服务端接口根据约定好的secret和传递过来的time以及key值md5加密，把加密后的值和sign对比，相同则签名成功．(一般time时间最好设置时效，我设置５分钟)

系统签名规则：
```
secret = 'e%w&mobile';
sign = md5(secret + '&' + time + '&' +  user_id);  //key值对应user_id
```
下面是我在定制项目中写的一个签名的通用类，验证签名只要调用SignSdk::SignSdk$time, $userId, $sign)判断结果就可以了
```
<?php

namespace  CustomBundle\Biz\Common;

class SignSdk
{
    const SDK_SECRET = 'e%w&mobile';

    public static function isSignCorrect($time, $userId, $sign)
    {
        if (time() - $time > 60 * 5) {
            return false;
        }

        $mySign = md5(self::SDK_SECRET .'&'.$time.'&'.$userId);
        if ($mySign != $sign) {
            return false;
        }

        return true;
    }
}
```